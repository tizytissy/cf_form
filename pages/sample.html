<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>    </head>
    <body>
        <div id="main">
            <h3>Inserire Codice Fiscale</h3>
            <span id="labelText"></span>
            <input type="hidden" id="name">
            <input type="hidden" id="surname">
            <input type="text" id="userInput" style="text-transform: uppercase;">
            <button onclick="onClick()">controlla</button>
            <div id="esito">esito</div>
        </div>
        <script type="text/javascript">
            async function submit(apiKey) {
            	var res = ''
                var cf = $("#userInput").val().toUpperCase();
                var msg = {
                    //you should valid attribute to data for JotForm
                    //to be able to use youw widget as required
                    valid: false,
                    value: cf
                };
             	await $.get("https://api.miocodicefiscale.com/reverse",
                 {    cf : cf, access_token :apiKey},
                function (response) {
                    res += response.message;
                    $("#esito").text(response.message);
                    msg.valid = response.status});
                    alert(msg.value + '; ' + msg.valid)
                return msg
            };
            function populate(data) {
                alert(data.value);
                //alert(Object.entries(data));
                let [nome, cognome, cf=''] = data.split('|');
                $("#name").val(nome);
                $("#surname").val(cognome);
            };
            //always subscribe to ready event and implement widget related code
            //inside callback function , it is the best practice while developing widgets
            JFCustomWidget.subscribe("ready", function(){
                var label = JFCustomWidget.getWidgetSetting('QuestionLabel');
                $('#labelText').innerHTML = label;
                JFCustomWidget.subscribe("populate", populate);
                //subscribe to form submit event
                JFCustomWidget.subscribe("submit", function(){
                    // send value to JotForm
                    alert('submit in esecuzione');
                    submit(JFCustomWidget.getWidgetSetting('apiKey')
                        ).then(JFCustomWidget.sendResult, alert);
                });
            });
            function onClick() {
                submit('0895b8b736b67a3306e95faed8f4802881f334d953f7a1a2eae0449994decd1813').then(alert)
            };
        </script>
    </body>
</html>

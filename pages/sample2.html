<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
		<script type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/luxon@3.1.0/build/global/luxon.min.js"></script>
	</head>
    <body>
        <div id="main">
			<label for="nome">Nome:</label>
            <input type="text" id="nome" style="text-transform: capitalize;"><br/>
			<label for="cognome">Cognome:</label>
            <input type="text" id="cognome" style="text-transform: capitalize;"><br/>
			<label for="codFisc">Codice Fiscale:</label>
            <input type="text" id="codFisc" style="text-transform: uppercase;"><br/>
            <div id="esito"></div>
        </div>
        <script type="text/javascript">
			var parametri = {adesso: luxon.DateTime.now(), apiKey: 'missing', checkMaggiorenne: '?'};
            async function checkCF2(msg, parms) {
                // se il codice è valido, controllo che corrisponda a nome e cognome
                if ((parms.cognome) && (parms.nome)) {
                alert("compare:" + parametri + ";" + parms);
                await $.get("https://api.miocodicefiscale.com/compare", parms,
                    function (response) {
                        if (response.status == "false") {
                            $("#esito").text(response.message);
                            msg.valid = response.status}})
                } else {
                        $("#esito").text("Inserire nome e cognome");
                        msg.valid = false
                }};
            async function checkCF() {
                var cf = $("#codFisc").val().toUpperCase();
                var nome = $("#nome").val().toUpperCase();
                var cognome = $("#cognome").val().toUpperCase();
                var msg = {
                    //you should valid attribute to data for JotForm
                    //to be able to use youw widget as required
                    valid: false,
                    value: cf.concat("|", nome, "|", cognome)
                };
                // per prima cosa, controllo la correttezza formale del codice fiscale
                alert("reverse:" + parametri);
                await $.get("https://api.miocodicefiscale.com/reverse",
                      {    cf : cf, access_token :parametri.apiKey},
                function (response) {
                    $("#esito").text(response.message);
                    msg.valid = response.status;
                    if (msg.valid == "true") {Promise.resolve(checkCF2(msg,
                        {cf : cf, lname: cognome, fname: nome, access_token :parametri.apiKey}));
                        // se richiesto, verifico che il cf sia quello di un maggiorenne
                        if (msg.valid) {
							alert("reverse:" + parametri.apiKey);
							var limit18 = parametri.adesso.minus({years: 18});
                            var data = response.data;
                            var dataNasc = luxon.DateTime.fromISO(
                                "20" + data.year + data.month + data.day);
                            if (dataNasc > parametri.adesso) {
                                var dataNasc = dataNasc.minus({years: 100})};
                            if ((dataNasc > limit18) && parametri.checkMaggiorenne) {
                                $("#esito").text("È richiesto il codice fiscale di un maggiorenne")
                            } else {
								$("#esito").text("Nato il " + dataNasc.setLocale('it').toFormat('dd MMMM yyyy')
								+ "a" + data.city)
							};
                    }}});
                return msg
            };
            async function atStartup() {
                //controllo il codice fiscale ad ogni tasto
				alert("atStartup4:" + parametri.adesso + ":" + parametri.apiKey + ":" + parametri.checkMaggiorenne + ":");
				var apiKey = JFCustomWidget.getWidgetSetting('apiKey');
                parametri.apiKey = apiKey;
                parametri.checkMaggiorenne = JFCustomWidget.getWidgetSetting('checkMaggiorenne');
				alert("atStartup4a:" + parametri.adesso + ":" + parametri.apiKey + ":" + apiKey + ":" + parametri[apiKey] + ":");
                parametri[apiKey] = apiKey;
				alert("atStartup4b:" + parametri.adesso + ":" + parametri.apiKey + ":" + apiKey + ":" + parametri[apiKey] + ":");
                function onSubmit() {
                    // send value to JotForm
                    checkCF().then(JFCustomWidget.sendSubmit, alert);
                };
				function onInputNominativo() {
					if ($("#codFisc").val()) {
						Promise.resolve(checkCF());
					};
				};
				$("#nome").on("input", onInputNominativo);
				$("#cognome").on("input", onInputNominativo);
				$("#codFisc").on("input", onSubmit);
				$("#esito").text("Inserisci i dati richiesti; " + parametri.checkMaggiorenne + ":");
                 JFCustomWidget.subscribe("submit", onSubmit);
            };
            //always subscribe to ready event and implement widget related code
            //inside callback function , it is the best practice while developing widgets
            JFCustomWidget.subscribe("ready", atStartup);
        </script>
    </body>
</html>
